<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<dom-module id="tangy-app">
  <template>
    <app-header reveals>
      <app-toolbar>
        <paper-icon-button icon="menu" onclick="this.domHost.shadowRoot.querySelector('app-drawer').toggle()"></paper-icon-button>
        <paper-icon-button icon="home" onclick="window.location = '/'"></paper-icon-button>
        <div main-title><!-- @TODO Should probably implement some page title system --></div>
        <paper-icon-button title="new page" id="newPageButton" on-click="newPage" icon="add"></paper-icon-button>
        <paper-icon-button title="new form page" id="newFormButton" on-click="newForm" icon="content-paste"></paper-icon-button>
        <paper-icon-button title="turn off editing" id="viewButton" on-click="view" icon="visibility" disabled></paper-icon-button>
        <paper-icon-button title="edit this form page" id="editButton" on-click="edit" icon="create"></paper-icon-button>
        <paper-icon-button title="save this form page" id="saveButton" on-click="save" icon="save"></paper-icon-button>
      </app-toolbar>
    </app-header>
    <app-drawer id="drawer" align="right" swipe-open>
      <div id="drawer-content">
        <paper-button on-click='generateCSV' raised>Download CSV</paper-button>
        <paper-button on-click='newSession' raised>New Session</paper-button>
        <template is="dom-repeat" items="{{sessions}}">
          <ul>
            <li> [[item.datetime]]  <paper-button id="[[item._id]]" on-click="resumeSession" raised>resume</paper-button> </li>
          </ul>
        </template>
      </div>
    </app-drawer>
    <style>
      :host {
        display: block;
      }
      #content {
        margin: 0 25px;
      }
      #drawer-content {
        padding: 15px;
      }
    </style>
    <div id="content">
      <slot></slot>
    </div>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class TangyApp extends Polymer.Element {
      static get is() { return 'tangy-app'; }
      static get properties() {
        return {
          prop1: {
            type: String,
            value: 'tangy-app'
          }
        };
      }
      constructor() {
        super()
        this.selfArchive = ''
        this.state = ''
        this.commitCounter = 0
        this.editor = ''
        this.templateTop = `
            <!DOCTYPE html>
              <html>
              <head>
                <link rel="import" href="tangy-app/tangy-app.html">
                <link rel="import" href="tangy-timed/tangy-timed.html">
                <link rel="import" href="tangy-form/tangy-form.html">
                <script src="bower_components/pouchdb/dist/pouchdb.js"> <\/script>
                <script src="bower_components/ckeditor/ckeditor.js"> <\/script>
              </head>
              <body>
                  <tangy-app>
          `;
        this.templateBottom = `
              <\/tangy-app>
            <\/body>
            <\/html>
        `;
      }

      async ready() {
        super.ready();
        /*
        CKEDITOR.on('instanceReady', (ev) => {
            this.editor = ev.editor;
            // you can also add more config for this instance of CKE here
            // e.g. editor.setReadOnly(false);
        });
        */
        // If there is a DatArchive API, enable editing, else hide editing UI.
        if (window.hasOwnProperty('DatArchive')) {
          this.selfArchive = new DatArchive('' + window.location)
        } else {
          this.$.editButton.style.display = 'none';
          this.$.viewButton.style.display = 'none';
        }
      }

      async openSettings() {
          this.$.settings_iframe.hidden = !this.$.settings_iframe.hidden
      }

      async newPage() {
        this.$.saveButton.disabled = true
        this.$.newPageButton.disabled = true
        this.$.newFormButton.disabled = true
        this.$.editButton.disabled = true
        let fileName = prompt('What should filename name be? Ex. about.html')
        await this.selfArchive.writeFile(`/${fileName}`, 
          this.templateTop + 
          + 'Enter content here.'
          + this.templateBottom, 'utf8')
        await this.selfArchive.commit()
        window.location = `${window.location.origin}/${fileName}` 
      }

      async newForm() {
        this.$.saveButton.disabled = true
        this.$.newPageButton.disabled = true
        this.$.newFormButton.disabled = true
        this.$.editButton.disabled = true
        let formName = prompt('What should form name be? Ex. my-tangy-form')
        // @TODO: Create a folder
        await this.selfArchive.mkdir(`/${formName}`)
        await this.selfArchive.writeFile(`/${formName}/index.html`, this.formTemplateTop.replace('{{FORM_NAME}}', formName) 
          + `<form>
              Enter content here.<br>
              <br>
              <br>
              <input type="submit" value="submit">
            </form>`
          + this.formTemplateBottom, 'utf8')
        await this.selfArchive.commit()
        window.location = `${window.location.origin}/${formName}/index.html` 
      }
      async save() {
        this.$.saveButton.disabled = true
        let pathName = window.location.pathname
        if (pathName == '/') pathName = '/index.html'
        await this.selfArchive.writeFile(pathName, this.templateTop + (document.querySelector('#editor')).innerHTML + this.templateBottom, 'utf8')
        await this.selfArchive.commit()
        setTimeout(() => {
          this.$.saveButton.disabled = false 
        }, 1000)
      }
      
      view() {
        this.$.editButton.disabled = false;
        this.$.saveButton.disabled = false;
        this.$.viewButton.disabled = true;
        (document.querySelector('#editor')).contentEditable = "false"
        this.editor.destroy();
      }
      
      edit() {
        this.$.editButton.disabled = true;
        this.$.saveButton.disabled = true;
        this.$.viewButton.disabled = false;
        (document.querySelector('#editor')).contentEditable = "true"
        CKEDITOR.inline( 'editor' );
      }

    }

    window.customElements.define(TangyApp.is, TangyApp);
  </script>
</dom-module>
